name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '6.0.x'
        
    - name: Restore dependencies
      run: dotnet restore GoogleCalendarWidget/GoogleCalendarWidget.csproj
      
    - name: Build single file executable
      run: |
        dotnet publish GoogleCalendarWidget/GoogleCalendarWidget.csproj `
          -c Release `
          -r win-x64 `
          --self-contained true `
          -p:PublishSingleFile=true `
          -p:PublishReadyToRun=true `
          -p:PublishTrimmed=false `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -o release/single-file
          
    - name: Build folder deployment
      run: |
        dotnet publish GoogleCalendarWidget/GoogleCalendarWidget.csproj `
          -c Release `
          -r win-x64 `
          --self-contained true `
          -p:PublishSingleFile=false `
          -o release/folder-deployment
          
    - name: Create installation scripts
      run: |
        # PowerShell 설치 스크립트
        $installScript = @'
        Write-Host "🎯 Material Calendar Widget 설치" -ForegroundColor Green
        $InstallDir = "$env:LOCALAPPDATA\MaterialCalendarWidget"
        if (!(Test-Path $InstallDir)) { New-Item -ItemType Directory -Path $InstallDir | Out-Null }
        Copy-Item "MaterialCalendarWidget.exe" $InstallDir -Force
        Write-Host "✅ 설치 완료! 설치 위치: $InstallDir" -ForegroundColor Green
        $response = Read-Host "🚀 Material Calendar Widget를 실행하시겠습니까? (Y/N)"
        if ($response -eq 'Y' -or $response -eq 'y') { Start-Process "$InstallDir\MaterialCalendarWidget.exe" }
        '@
        $installScript | Out-File -FilePath "release/single-file/install.ps1" -Encoding UTF8
        
        # 배치 설치 스크립트
        @'
        @echo off
        echo 🎯 Material Calendar Widget 설치
        set "INSTALL_DIR=%LOCALAPPDATA%\MaterialCalendarWidget"
        if not exist "%INSTALL_DIR%" mkdir "%INSTALL_DIR%"
        copy "MaterialCalendarWidget.exe" "%INSTALL_DIR%\" >nul
        echo ✅ 설치 완료! 설치 위치: %INSTALL_DIR%
        echo 🚀 Material Calendar Widget를 실행하시겠습니까?
        pause
        start "" "%INSTALL_DIR%\MaterialCalendarWidget.exe"
        '@ | Out-File -FilePath "release/single-file/install.bat" -Encoding UTF8
        
        # README 생성
        @'
        # Material Calendar Widget
        
        ## 🎯 설치 방법
        
        ### 방법 1 - 단일 실행 파일 (권장)
        1. `single-file` 폴더로 이동
        2. `install.ps1` (PowerShell) 또는 `install.bat` 실행
        
        ### 방법 2 - 폴더 배포
        1. `folder-deployment` 폴더를 원하는 위치에 복사
        2. `MaterialCalendarWidget.exe` 실행
        
        ## 📋 요구사항
        - Windows 10/11
        - 인터넷 연결 (Google API)
        - Google 계정
        
        ## 🌐 링크
        - 홈페이지: https://fbdjzk2002.github.io/GoogleCalendarWidget/
        - GitHub: https://github.com/fbdjzk2002/GoogleCalendarWidget
        '@ | Out-File -FilePath "release/README.md" -Encoding UTF8
        
    - name: Create ZIP archives
      run: |
        # 단일 파일 아카이브
        Compress-Archive -Path "release/single-file/*" -DestinationPath "MaterialCalendarWidget-SingleFile.zip"
        
        # 폴더 배포 아카이브
        Compress-Archive -Path "release/folder-deployment/*" -DestinationPath "MaterialCalendarWidget-FolderDeployment.zip"
        
        # 전체 아카이브
        Compress-Archive -Path "release/*" -DestinationPath "MaterialCalendarWidget-Complete.zip"
        
    - name: Get file sizes
      id: sizes
      run: |
        $singleSize = [math]::Round((Get-Item "MaterialCalendarWidget-SingleFile.zip").Length / 1MB, 1)
        $folderSize = [math]::Round((Get-Item "MaterialCalendarWidget-FolderDeployment.zip").Length / 1MB, 1)
        $completeSize = [math]::Round((Get-Item "MaterialCalendarWidget-Complete.zip").Length / 1MB, 1)
        
        echo "single-size=$singleSize" >> $env:GITHUB_OUTPUT
        echo "folder-size=$folderSize" >> $env:GITHUB_OUTPUT
        echo "complete-size=$completeSize" >> $env:GITHUB_OUTPUT
        
    - name: Create Release
      uses: actions/create-release@v1
      id: create_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.event.inputs.version || github.ref_name }}
        release_name: Material Calendar Widget ${{ github.event.inputs.version || github.ref_name }}
        body: |
          # 🎉 Material Calendar Widget ${{ github.event.inputs.version || github.ref_name }}
          
          Google Calendar를 위한 Material Design 데스크톱 위젯입니다.
          
          ## 📦 다운로드 옵션
          
          - **MaterialCalendarWidget-SingleFile.zip** (${{ steps.sizes.outputs.single-size }} MB) - 권장
            - 단일 실행 파일 + 설치 스크립트
            - .NET 런타임 포함
          
          - **MaterialCalendarWidget-FolderDeployment.zip** (${{ steps.sizes.outputs.folder-size }} MB)
            - 폴더 형태 배포
            - 수동 설치
          
          - **MaterialCalendarWidget-Complete.zip** (${{ steps.sizes.outputs.complete-size }} MB)
            - 모든 배포 형태 포함
          
          ## 🚀 설치 방법
          
          1. 원하는 ZIP 파일 다운로드
          2. 압축 해제
          3. `install.ps1` 또는 `install.bat` 실행
          
          ## 📋 요구사항
          
          - Windows 10/11
          - Google 계정
          - 인터넷 연결
          
          ## 🌐 자세한 정보
          
          - [홈페이지](https://fbdjzk2002.github.io/GoogleCalendarWidget/)
          - [사용 가이드](https://github.com/fbdjzk2002/GoogleCalendarWidget#readme)
          - [문제 신고](https://github.com/fbdjzk2002/GoogleCalendarWidget/issues)
        draft: false
        prerelease: false
        
    - name: Upload Single File Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./MaterialCalendarWidget-SingleFile.zip
        asset_name: MaterialCalendarWidget-SingleFile.zip
        asset_content_type: application/zip
        
    - name: Upload Folder Deployment Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./MaterialCalendarWidget-FolderDeployment.zip
        asset_name: MaterialCalendarWidget-FolderDeployment.zip
        asset_content_type: application/zip
        
    - name: Upload Complete Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./MaterialCalendarWidget-Complete.zip
        asset_name: MaterialCalendarWidget-Complete.zip
        asset_content_type: application/zip
