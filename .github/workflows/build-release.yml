name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '6.0.x'
        
    - name: Restore dependencies
      run: dotnet restore GoogleCalendarWidget/GoogleCalendarWidget.csproj
      
    - name: Build single file executable
      run: |
        dotnet publish GoogleCalendarWidget/GoogleCalendarWidget.csproj `
          -c Release `
          -r win-x64 `
          --self-contained true `
          -p:PublishSingleFile=true `
          -p:PublishReadyToRun=true `
          -p:PublishTrimmed=false `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -o release/single-file
          
    - name: Build folder deployment
      run: |
        dotnet publish GoogleCalendarWidget/GoogleCalendarWidget.csproj `
          -c Release `
          -r win-x64 `
          --self-contained true `
          -p:PublishSingleFile=false `
          -o release/folder-deployment
          
    - name: Create installation scripts
      run: |
        # PowerShell ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸
        $installScript = @'
        Write-Host "ğŸ¯ Material Calendar Widget ì„¤ì¹˜" -ForegroundColor Green
        $InstallDir = "$env:LOCALAPPDATA\MaterialCalendarWidget"
        if (!(Test-Path $InstallDir)) { New-Item -ItemType Directory -Path $InstallDir | Out-Null }
        Copy-Item "MaterialCalendarWidget.exe" $InstallDir -Force
        Write-Host "âœ… ì„¤ì¹˜ ì™„ë£Œ! ì„¤ì¹˜ ìœ„ì¹˜: $InstallDir" -ForegroundColor Green
        $response = Read-Host "ğŸš€ Material Calendar Widgetë¥¼ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Y/N)"
        if ($response -eq 'Y' -or $response -eq 'y') { Start-Process "$InstallDir\MaterialCalendarWidget.exe" }
        '@
        $installScript | Out-File -FilePath "release/single-file/install.ps1" -Encoding UTF8
        
        # ë°°ì¹˜ ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸
        @'
        @echo off
        echo ğŸ¯ Material Calendar Widget ì„¤ì¹˜
        set "INSTALL_DIR=%LOCALAPPDATA%\MaterialCalendarWidget"
        if not exist "%INSTALL_DIR%" mkdir "%INSTALL_DIR%"
        copy "MaterialCalendarWidget.exe" "%INSTALL_DIR%\" >nul
        echo âœ… ì„¤ì¹˜ ì™„ë£Œ! ì„¤ì¹˜ ìœ„ì¹˜: %INSTALL_DIR%
        echo ğŸš€ Material Calendar Widgetë¥¼ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
        pause
        start "" "%INSTALL_DIR%\MaterialCalendarWidget.exe"
        '@ | Out-File -FilePath "release/single-file/install.bat" -Encoding UTF8
        
        # README ìƒì„±
        @'
        # Material Calendar Widget
        
        ## ğŸ¯ ì„¤ì¹˜ ë°©ë²•
        
        ### ë°©ë²• 1 - ë‹¨ì¼ ì‹¤í–‰ íŒŒì¼ (ê¶Œì¥)
        1. `single-file` í´ë”ë¡œ ì´ë™
        2. `install.ps1` (PowerShell) ë˜ëŠ” `install.bat` ì‹¤í–‰
        
        ### ë°©ë²• 2 - í´ë” ë°°í¬
        1. `folder-deployment` í´ë”ë¥¼ ì›í•˜ëŠ” ìœ„ì¹˜ì— ë³µì‚¬
        2. `MaterialCalendarWidget.exe` ì‹¤í–‰
        
        ## ğŸ“‹ ìš”êµ¬ì‚¬í•­
        - Windows 10/11
        - ì¸í„°ë„· ì—°ê²° (Google API)
        - Google ê³„ì •
        
        ## ğŸŒ ë§í¬
        - í™ˆí˜ì´ì§€: https://fbdjzk2002.github.io/GoogleCalendarWidget/
        - GitHub: https://github.com/fbdjzk2002/GoogleCalendarWidget
        '@ | Out-File -FilePath "release/README.md" -Encoding UTF8
        
    - name: Create ZIP archives
      run: |
        # ë‹¨ì¼ íŒŒì¼ ì•„ì¹´ì´ë¸Œ
        Compress-Archive -Path "release/single-file/*" -DestinationPath "MaterialCalendarWidget-SingleFile.zip"
        
        # í´ë” ë°°í¬ ì•„ì¹´ì´ë¸Œ
        Compress-Archive -Path "release/folder-deployment/*" -DestinationPath "MaterialCalendarWidget-FolderDeployment.zip"
        
        # ì „ì²´ ì•„ì¹´ì´ë¸Œ
        Compress-Archive -Path "release/*" -DestinationPath "MaterialCalendarWidget-Complete.zip"
        
    - name: Get file sizes
      id: sizes
      run: |
        $singleSize = [math]::Round((Get-Item "MaterialCalendarWidget-SingleFile.zip").Length / 1MB, 1)
        $folderSize = [math]::Round((Get-Item "MaterialCalendarWidget-FolderDeployment.zip").Length / 1MB, 1)
        $completeSize = [math]::Round((Get-Item "MaterialCalendarWidget-Complete.zip").Length / 1MB, 1)
        
        echo "single-size=$singleSize" >> $env:GITHUB_OUTPUT
        echo "folder-size=$folderSize" >> $env:GITHUB_OUTPUT
        echo "complete-size=$completeSize" >> $env:GITHUB_OUTPUT
        
    - name: Create Release
      uses: actions/create-release@v1
      id: create_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.event.inputs.version || github.ref_name }}
        release_name: Material Calendar Widget ${{ github.event.inputs.version || github.ref_name }}
        body: |
          # ğŸ‰ Material Calendar Widget ${{ github.event.inputs.version || github.ref_name }}
          
          Google Calendarë¥¼ ìœ„í•œ Material Design ë°ìŠ¤í¬í†± ìœ„ì ¯ì…ë‹ˆë‹¤.
          
          ## ğŸ“¦ ë‹¤ìš´ë¡œë“œ ì˜µì…˜
          
          - **MaterialCalendarWidget-SingleFile.zip** (${{ steps.sizes.outputs.single-size }} MB) - ê¶Œì¥
            - ë‹¨ì¼ ì‹¤í–‰ íŒŒì¼ + ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸
            - .NET ëŸ°íƒ€ì„ í¬í•¨
          
          - **MaterialCalendarWidget-FolderDeployment.zip** (${{ steps.sizes.outputs.folder-size }} MB)
            - í´ë” í˜•íƒœ ë°°í¬
            - ìˆ˜ë™ ì„¤ì¹˜
          
          - **MaterialCalendarWidget-Complete.zip** (${{ steps.sizes.outputs.complete-size }} MB)
            - ëª¨ë“  ë°°í¬ í˜•íƒœ í¬í•¨
          
          ## ğŸš€ ì„¤ì¹˜ ë°©ë²•
          
          1. ì›í•˜ëŠ” ZIP íŒŒì¼ ë‹¤ìš´ë¡œë“œ
          2. ì••ì¶• í•´ì œ
          3. `install.ps1` ë˜ëŠ” `install.bat` ì‹¤í–‰
          
          ## ğŸ“‹ ìš”êµ¬ì‚¬í•­
          
          - Windows 10/11
          - Google ê³„ì •
          - ì¸í„°ë„· ì—°ê²°
          
          ## ğŸŒ ìì„¸í•œ ì •ë³´
          
          - [í™ˆí˜ì´ì§€](https://fbdjzk2002.github.io/GoogleCalendarWidget/)
          - [ì‚¬ìš© ê°€ì´ë“œ](https://github.com/fbdjzk2002/GoogleCalendarWidget#readme)
          - [ë¬¸ì œ ì‹ ê³ ](https://github.com/fbdjzk2002/GoogleCalendarWidget/issues)
        draft: false
        prerelease: false
        
    - name: Upload Single File Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./MaterialCalendarWidget-SingleFile.zip
        asset_name: MaterialCalendarWidget-SingleFile.zip
        asset_content_type: application/zip
        
    - name: Upload Folder Deployment Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./MaterialCalendarWidget-FolderDeployment.zip
        asset_name: MaterialCalendarWidget-FolderDeployment.zip
        asset_content_type: application/zip
        
    - name: Upload Complete Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./MaterialCalendarWidget-Complete.zip
        asset_name: MaterialCalendarWidget-Complete.zip
        asset_content_type: application/zip
